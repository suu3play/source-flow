# ソース管理・リリース管理システム 仕様書

## 1. システム概要

### 1.1 システム名称
ソース管理・リリース管理システム (Source & Release Management System)

### 1.2 システム目的
任意のサーバから定期的にファイルをローカル環境へ同期し、ファイルの変更履歴を管理、リリース作業を効率化するためのシステム。

### 1.3 主要機能概要
1. **ソース取得機能**: 任意のサーバまたはローカルパスからファイルを取得（増分コピー対応）
2. **ファイル管理機能**: ディレクトリ構成とファイル一覧の確認
3. **履歴管理機能**: ファイルの変更履歴追跡と管理
4. **比較機能**: 履歴間比較、WinMerge連携
5. **リリース管理機能**: ディレクトリ間比較とリリース実行
6. **バックアップ機能**: リリース前後のファイルバックアップ
7. **設定管理機能**: パラメータファイルによる設定管理

## 2. 要件定義

### 2.1 機能要件
- **F001**: サーバまたはローカルパスからの定期的なファイルコピー（増分コピー対応）
- **F002**: 取得ファイルの一覧表示とディレクトリ構成確認
- **F003**: ファイル毎の変更履歴管理と表示
- **F004**: 任意の2履歴選択によるWinMerge比較実行
- **F005**: リリース元・先ディレクトリの比較機能
- **F006**: ディレクトリ間でのリリース実行機能
- **F007**: リリース前後のファイルバックアップ機能
- **F008**: パラメータファイルによる各処理設定管理

### 2.2 非機能要件
- **N001**: Windows環境での動作保証
- **N002**: WinMergeとの外部連携
- **N003**: 大容量ファイル対応（効率的な増分コピー）
- **N004**: ログ出力による操作履歴記録
- **N005**: エラーハンドリングと復旧機能
- **N006**: 設定変更時の即座反映

### 2.3 制約事項
- Windows環境専用設計
- WinMergeがインストール済みであること
- サーバアクセス権限が適切に設定されていること
- 十分なローカルストレージ容量があること

## 3. システム構成

### 3.1 システム構成図
```
[任意サーバ/ローカルパス] ←→ [ローカル環境]
           ↓                    ↓
      [ソースファイル]          [同期ファイル] → [履歴管理DB]
                                  ↓
                              [比較・リリース機能] ← [WinMerge]
                                  ↓
                              [バックアップ]
```

### 3.2 主要コンポーネント
1. **ソース取得モジュール**: サーバ/ローカルパス連携と増分コピー
2. **ファイル管理モジュール**: ファイル一覧管理
3. **履歴管理モジュール**: 変更履歴追跡
4. **比較モジュール**: ファイル・ディレクトリ比較
5. **リリース管理モジュール**: リリース実行制御
6. **バックアップモジュール**: バックアップ管理
7. **設定管理モジュール**: パラメータ管理
8. **UI層**: ユーザーインターフェース

## 4. 機能仕様

### 4.1 ソース取得機能（F001）
**目的**: 任意のサーバまたはローカルパスから定期的にファイルをローカル環境へコピー

**詳細仕様**:
- **リモートソース**: FTP, SFTP, SMB, HTTP(S)対応
- **ローカルソース**: 直接パス指定によるローカルディレクトリ対応
- 増分コピー: タイムスタンプ、サイズ比較による差分検出
- スケジューリング: Cron式による定期実行設定
- 除外設定: ファイル・ディレクトリの除外パターン指定
- 暗号化転送: SFTP、HTTPSによるセキュア転送対応（リモート時）
- ローカルアクセス: UNC パス、ドライブパスによる直接アクセス

**入力**:
- **リモートモード**: サーバ接続情報（ホスト、ポート、認証情報）
- **ローカルモード**: 直接パス指定（例: D:\Source, \\server\share\path）
- 同期対象パス（ソース側、ローカル側）
- スケジュール設定
- 除外パターン

**出力**:
- 同期結果（成功/失敗ファイル数）
- 同期ログ
- エラー情報

### 4.2 ファイル管理機能（F002）
**目的**: 取得したファイルの一覧とディレクトリ構成の確認

**詳細仕様**:
- ツリー表示: ディレクトリ構成のツリー形式表示
- ファイル詳細: サイズ、更新日時、ハッシュ値表示
- フィルタ機能: ファイル名、拡張子、更新日でのフィルタリング
- ソート機能: 各項目での昇順・降順ソート
- 検索機能: ファイル名での部分一致検索

**画面構成**:
- 左ペイン: ディレクトリツリー
- 右ペイン: ファイル一覧（詳細情報付き）
- 検索バー: ファイル検索入力欄
- フィルタ設定: 拡張子、日付範囲フィルタ

### 4.3 履歴管理機能（F003）
**目的**: 各ファイルの変更履歴を記録・確認

**詳細仕様**:
- 変更検知: ハッシュ値比較による変更検出
- 履歴記録: 変更日時、ファイルサイズ、ハッシュ値を記録
- 履歴表示: 時系列順での履歴一覧表示
- 世代管理: 設定可能な世代数での履歴保持
- メタデータ: 変更者情報（可能な場合）の記録

**データ構造**:
```sql
FileHistory (
    id: INTEGER PRIMARY KEY,
    file_path: TEXT,
    version: INTEGER,
    hash_value: TEXT,
    file_size: INTEGER,
    modified_date: DATETIME,
    created_date: DATETIME,
    change_type: TEXT  -- ADD, MODIFY, DELETE
)
```

### 4.4 比較機能（F004）
**目的**: 任意の2履歴を選択してWinMergeによる比較実行

**詳細仕様**:
- 履歴選択: 2つの履歴バージョンを選択可能
- WinMerge連携: 外部プロセスとしてWinMerge起動
- 一時ファイル: 比較用の一時ファイル作成・削除
- バイナリ対応: テキスト・バイナリファイルの判定と適切な比較

**処理フロー**:
1. 2つの履歴バージョンを選択
2. 各バージョンのファイルを一時ディレクトリに復元
3. WinMergeコマンドライン引数作成
4. WinMergeプロセス起動
5. 比較終了後、一時ファイル削除

### 4.5 リリース管理機能（F005, F006）
**目的**: リリース元・先ディレクトリの比較とリリース実行

**詳細仕様**:
- ディレクトリ比較: ファイル単位での差分検出
- 変更種別: 新規、更新、削除の分類
- プレビュー機能: リリース内容の事前確認
- 選択リリース: 個別ファイル選択によるリリース
- ロールバック: リリース失敗時の自動復旧

**比較結果表示**:
- 新規ファイル: 緑色表示
- 更新ファイル: 黄色表示  
- 削除対象: 赤色表示
- チェックボックス: 個別選択可能

### 4.6 バックアップ機能（F007）
**目的**: リリース前後のファイルバックアップ取得

**詳細仕様**:
- 自動バックアップ: リリース実行前の自動バックアップ
- バックアップ形式: ZIP圧縮による世代管理
- 保持期間: 設定可能なバックアップ保持期間
- 復元機能: バックアップからの復元機能
- 命名規則: 日時を含む一意なバックアップ名

**バックアップ構造**:
```
backups/
├── pre_release_YYYYMMDD_HHMMSS.zip
├── post_release_YYYYMMDD_HHMMSS.zip
└── backup_manifest.json
```

### 4.7 設定管理機能（F008）
**目的**: 各処理に必要なパラメータをファイルで管理

**詳細仕様**:
- 設定形式: JSON形式での設定ファイル
- 分割管理: 機能別の設定ファイル分割
- 動的読込: 設定変更時の動的リロード
- 設定検証: 設定値の妥当性チェック
- デフォルト設定: 設定欠如時のデフォルト値適用

**設定ファイル構成**:
```
config/
├── source_sync.json     # ソース取得設定
├── file_management.json # ファイル管理設定  
├── release_config.json  # リリース設定
├── backup_config.json   # バックアップ設定
└── app_config.json     # アプリケーション設定
```

## 5. 技術仕様

### 5.1 開発環境・技術スタック
- **フレームワーク**: .NET 6.0 / WPF
- **データベース**: SQLite（履歴管理）
- **設定管理**: JSON形式
- **ログ出力**: NLog
- **暗号化**: System.Security.Cryptography
- **圧縮**: System.IO.Compression

### 5.2 アーキテクチャ
**パターン**: MVVM (Model-View-ViewModel)
**構成**:
- **View**: WPF UserControl
- **ViewModel**: データバインディング、コマンド処理
- **Model**: ビジネスロジック、データアクセス
- **Service**: 外部システム連携

### 5.3 データベース設計
```sql
-- ファイル履歴テーブル
CREATE TABLE file_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_path TEXT NOT NULL,
    version INTEGER NOT NULL,
    hash_value TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    modified_date DATETIME NOT NULL,
    created_date DATETIME NOT NULL,
    change_type TEXT NOT NULL
);

-- 同期ジョブ履歴テーブル  
CREATE TABLE sync_jobs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    job_name TEXT NOT NULL,
    server_host TEXT NOT NULL,
    sync_start DATETIME NOT NULL,
    sync_end DATETIME,
    status TEXT NOT NULL,
    files_synced INTEGER DEFAULT 0,
    errors_count INTEGER DEFAULT 0,
    log_message TEXT
);

-- リリース履歴テーブル
CREATE TABLE release_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    release_name TEXT NOT NULL,
    source_path TEXT NOT NULL,
    target_path TEXT NOT NULL,
    release_date DATETIME NOT NULL,
    files_released INTEGER DEFAULT 0,
    backup_path TEXT,
    status TEXT NOT NULL
);
```

## 6. 画面設計

### 6.1 メイン画面
**レイアウト**: タブ形式の画面構成
**タブ構成**:
1. **ダッシュボード**: システム状態、最新同期情報
2. **ソース取得**: 取得設定、実行、ログ確認
3. **ファイル管理**: ファイル一覧、履歴確認
4. **比較・リリース**: ディレクトリ比較、リリース実行
5. **設定**: システム設定、パラメータ管理

### 6.2 主要画面の詳細

#### 6.2.1 ダッシュボード
- システム状態表示
- 最新同期ジョブ結果
- エラー・警告アラート
- クイックアクション

#### 6.2.2 ソース取得画面
- ソースタイプ選択（サーバ/ローカルパス）
- **サーバモード**: サーバ接続設定
- **ローカルパスモード**: パス指定（参照ボタン付き）
- 同期対象パス設定
- スケジュール設定
- 実行ボタン、進捗表示
- 同期ログ表示

#### 6.2.3 ファイル管理画面
- 左ペイン: ディレクトリツリー
- 右ペイン: ファイル一覧
- 下ペイン: 選択ファイルの履歴表示
- 検索・フィルタ機能

#### 6.2.4 比較・リリース画面
- リリース元・先パス指定
- 比較実行ボタン
- 差分一覧表示
- リリース実行機能
- バックアップ設定

## 7. パラメータファイル仕様

### 7.1 ソース取得設定 (source_sync.json)
```json
{
  "sources": [
    {
      "name": "開発サーバ（リモート）",
      "source_type": "remote",
      "protocol": "SFTP",
      "host": "dev-server.company.com",
      "port": 22,
      "username": "devuser",
      "password_encrypted": "...",
      "source_path": "/var/www/source",
      "local_path": "C:\\LocalSync\\dev",
      "schedule": "0 */2 * * *",
      "exclude_patterns": [
        "*.tmp",
        "node_modules/",
        ".git/"
      ],
      "enabled": true
    },
    {
      "name": "ローカル開発環境",
      "source_type": "local",
      "source_path": "D:\\Development\\MyProject",
      "local_path": "C:\\LocalSync\\local_dev",
      "schedule": "0 */1 * * *",
      "exclude_patterns": [
        "bin/",
        "obj/",
        "*.user"
      ],
      "enabled": true
    },
    {
      "name": "共有フォルダ（UNCパス）",
      "source_type": "local",
      "source_path": "\\\\file-server\\shared\\source",
      "local_path": "C:\\LocalSync\\shared",
      "schedule": "0 0 * * *",
      "exclude_patterns": [
        "~$*",
        "*.lock"
      ],
      "enabled": true
    }
  ],
  "sync_options": {
    "timeout_seconds": 300,
    "retry_count": 3,
    "preserve_permissions": false,
    "verify_checksum": true,
    "local_access_timeout": 30
  }
}
```

### 7.2 アプリケーション設定 (app_config.json)
```json
{
  "database": {
    "path": "data\\history.db",
    "backup_enabled": true,
    "backup_interval_days": 7
  },
  "logging": {
    "level": "Info",
    "max_file_size_mb": 10,
    "max_files": 5,
    "log_directory": "logs"
  },
  "ui": {
    "theme": "Light",
    "auto_refresh_interval": 30,
    "max_history_display": 100
  },
  "external_tools": {
    "winmerge_path": "C:\\Program Files (x86)\\WinMerge\\WinMergeU.exe",
    "text_editor": "notepad.exe"
  }
}
```

### 7.3 リリース設定 (release_config.json)
```json
{
  "release_profiles": [
    {
      "name": "本番リリース",
      "source_path": "C:\\LocalSync\\staging",
      "target_path": "\\\\prod-server\\webapp",
      "backup_enabled": true,
      "backup_path": "C:\\Backups\\Production",
      "pre_release_script": "",
      "post_release_script": "",
      "exclude_patterns": [
        "*.log",
        "config\\local.*"
      ]
    }
  ],
  "backup_settings": {
    "retention_days": 30,
    "compression_level": "Normal",
    "include_metadata": true
  }
}
```

## 8. 運用・保守

### 8.1 ログ管理
- **アプリケーションログ**: 処理実行、エラー情報
- **同期ログ**: サーバ同期の詳細ログ
- **リリースログ**: リリース実行の詳細ログ
- **監査ログ**: ユーザー操作の記録

### 8.2 バックアップ・復旧
- **データベースバックアップ**: 定期的なSQLiteファイルバックアップ
- **設定ファイルバックアップ**: パラメータファイルのバックアップ
- **リリースファイルバックアップ**: リリース前後の自動バックアップ

### 8.3 監視・アラート
- **同期失敗監視**: サーバ同期失敗時のアラート
- **ディスク容量監視**: ローカルストレージ使用量監視
- **プロセス監視**: アプリケーションの動作状況監視

## 9. 開発・実装計画

### 9.1 開発フェーズ
1. **Phase 1**: 基盤機能（設定管理、データベース、UI基盤）
2. **Phase 2**: ソース取得機能（FTP/SFTP/ローカルパス対応）
3. **Phase 3**: ファイル管理・履歴管理機能
4. **Phase 4**: 比較・WinMerge連携機能
5. **Phase 5**: リリース管理・バックアップ機能
6. **Phase 6**: 統合テスト・性能最適化

### 9.2 成果物
- 実行可能アプリケーション (.exe)
- インストーラー (.msi)
- 設定ファイルテンプレート
- ユーザーマニュアル
- 運用手順書

### 9.3 品質保証
- 単体テスト (MSTest)
- 統合テスト
- 性能テスト
- セキュリティテスト
- ユーザビリティテスト

---
**文書作成日**: 2025-01-08
**バージョン**: 1.0
**作成者**: システム設計担当