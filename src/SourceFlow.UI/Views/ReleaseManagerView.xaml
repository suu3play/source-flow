<UserControl x:Class="SourceFlow.UI.Views.ReleaseManagerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:converters="clr-namespace:SourceFlow.UI.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">
    
    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <Style TargetType="GroupBox">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Padding" Value="10"/>
        </Style>
        <Style TargetType="Button">
            <Setter Property="Margin" Value="5,2"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="MinWidth" Value="80"/>
        </Style>
        <Style TargetType="TextBox">
            <Setter Property="Margin" Value="5,2"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        <Style TargetType="CheckBox">
            <Setter Property="Margin" Value="5,2"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ヘッダー -->
        <StackPanel Grid.Row="0" Margin="10">
            <TextBlock Text="比較・リリース管理" FontSize="24" FontWeight="Bold" Margin="0,0,0,5"/>
            <TextBlock Text="ファイルの比較とリリース作業を管理します" FontSize="14" Foreground="Gray"/>
        </StackPanel>

        <!-- メインコンテンツ -->
        <TabControl Grid.Row="1" Margin="10,0,10,0">
            
            <!-- リリース作成タブ -->
            <TabItem Header="リリース作成">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="200"/>
                    </Grid.RowDefinitions>

                    <!-- 設定エリア -->
                    <GroupBox Grid.Row="0" Header="リリース設定">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="ソースパス:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding SourcePath}" IsReadOnly="True"/>
                            <Button Grid.Row="0" Grid.Column="2" Content="参照..." Command="{Binding BrowseSourceCommand}"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="ターゲットパス:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding TargetPath}" IsReadOnly="True"/>
                            <Button Grid.Row="1" Grid.Column="2" Content="参照..." Command="{Binding BrowseTargetCommand}"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="リリース名:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding ReleaseName}"/>

                            <CheckBox Grid.Row="3" Grid.Column="1" IsChecked="{Binding CreateBackup}" Content="バックアップを作成する"/>

                            <StackPanel Grid.Row="4" Grid.Column="1" Orientation="Horizontal">
                                <Button Content="比較実行" Command="{Binding CompareCommand}" FontWeight="Bold"/>
                                <Button Content="キャンセル" Command="{Binding CancelOperationCommand}" 
                                       Visibility="{Binding IsComparing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                       Background="Orange" Foreground="White"/>
                                <ProgressBar Width="100" Height="20" Margin="10,0,0,0"
                                           Visibility="{Binding IsComparing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                           IsIndeterminate="True"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>

                    <!-- 比較結果 -->
                    <GroupBox Grid.Row="1" Header="比較結果">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- ツールバー -->
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                                <Button Content="全選択" Command="{Binding SelectAllCommand}" 
                                       ToolTip="すべてのファイルを選択します"/>
                                <Button Content="全解除" Command="{Binding UnselectAllCommand}" 
                                       ToolTip="すべてのファイルの選択を解除します"/>
                                <Separator/>
                                <Button Content="WinMerge" Command="{Binding OpenWinMergeCommand}" 
                                       CommandParameter="{Binding SelectedItem, ElementName=ComparisonList}"
                                       ToolTip="選択されたファイルをWinMergeで比較します"/>
                            </StackPanel>

                            <!-- 結果リスト -->
                            <ListView x:Name="ComparisonList" Grid.Row="1" ItemsSource="{Binding ComparisonResults}"
                                     VirtualizingStackPanel.IsVirtualizing="True"
                                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                                     ScrollViewer.IsDeferredScrollingEnabled="True">
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header="" Width="30">
                                            <GridViewColumn.CellTemplate>
                                                <DataTemplate>
                                                    <CheckBox IsChecked="{Binding Selected}" HorizontalAlignment="Center"/>
                                                </DataTemplate>
                                            </GridViewColumn.CellTemplate>
                                        </GridViewColumn>
                                        <GridViewColumn Header="変更種別" Width="80">
                                            <GridViewColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding ChangeType}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding ChangeType}" Value="Add">
                                                                        <Setter Property="Foreground" Value="Green"/>
                                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding ChangeType}" Value="Modify">
                                                                        <Setter Property="Foreground" Value="Orange"/>
                                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding ChangeType}" Value="Delete">
                                                                        <Setter Property="Foreground" Value="Red"/>
                                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </DataTemplate>
                                            </GridViewColumn.CellTemplate>
                                        </GridViewColumn>
                                        <GridViewColumn Header="ファイルパス" Width="400" DisplayMemberBinding="{Binding FilePath}"/>
                                        <GridViewColumn Header="ソースサイズ" Width="100" DisplayMemberBinding="{Binding SourceSize}"/>
                                        <GridViewColumn Header="ターゲットサイズ" Width="100" DisplayMemberBinding="{Binding TargetSize}"/>
                                        <GridViewColumn Header="ソース更新日時" Width="150" DisplayMemberBinding="{Binding SourceModified, StringFormat=yyyy/MM/dd HH:mm:ss}"/>
                                        <GridViewColumn Header="ターゲット更新日時" Width="150" DisplayMemberBinding="{Binding TargetModified, StringFormat=yyyy/MM/dd HH:mm:ss}"/>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                        </Grid>
                    </GroupBox>

                    <!-- リリース実行エリア -->
                    <GroupBox Grid.Row="2" Header="リリース実行">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal">
                                <Button Content="リリース実行" Command="{Binding CreateReleaseCommand}" FontWeight="Bold"
                                       ToolTip="選択されたファイルをターゲットディレクトリにリリースします"/>
                                <Button Content="キャンセル" Command="{Binding CancelOperationCommand}" 
                                       Visibility="{Binding IsReleasing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                       Background="Red" Foreground="White"
                                       ToolTip="実行中の操作をキャンセルします"/>
                                <TextBlock Text="{Binding ComparisonResults.Count, StringFormat={}{0} 件中 }" VerticalAlignment="Center" Margin="20,0,0,0"/>
                                <TextBlock VerticalAlignment="Center" Text="選択されたファイルをリリースします"/>
                            </StackPanel>

                            <ProgressBar Grid.Row="1" Height="20" Margin="5" 
                                        Value="{Binding ReleaseProgress}" Maximum="100"
                                        Visibility="{Binding IsReleasing, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                            <TextBlock Grid.Row="2" Text="選択されたファイルがターゲットディレクトリにリリースされます。
バックアップオプションが有効な場合、リリース前にターゲットディレクトリのバックアップが作成されます。"
                                      TextWrapping="Wrap" Foreground="Gray" Margin="5"/>
                        </Grid>
                    </GroupBox>
                </Grid>
            </TabItem>

            <!-- リリース履歴タブ -->
            <TabItem Header="リリース履歴">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- 統計情報 -->
                    <GroupBox Grid.Row="0" Header="統計情報">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="総リリース数" FontWeight="Bold"/>
                                <TextBlock Text="{Binding Statistics.TotalReleases}" FontSize="18" Foreground="Blue"/>
                            </StackPanel>

                            <StackPanel Grid.Column="1">
                                <TextBlock Text="成功リリース数" FontWeight="Bold"/>
                                <TextBlock Text="{Binding Statistics.SuccessfulReleases}" FontSize="18" Foreground="Green"/>
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="今週のリリース数" FontWeight="Bold"/>
                                <TextBlock Text="{Binding Statistics.LastWeekReleases}" FontSize="18" Foreground="Orange"/>
                            </StackPanel>

                            <StackPanel Grid.Column="3">
                                <TextBlock Text="総ファイル数" FontWeight="Bold"/>
                                <TextBlock Text="{Binding Statistics.TotalFilesReleased}" FontSize="18" Foreground="Purple"/>
                            </StackPanel>

                            <StackPanel Grid.Column="4">
                                <TextBlock Text="成功率" FontWeight="Bold"/>
                                <TextBlock Text="{Binding Statistics.SuccessRate, StringFormat={}{0:F1}%}" FontSize="18" Foreground="DarkGreen"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>

                    <!-- 履歴リスト -->
                    <GroupBox Grid.Row="1" Header="リリース履歴">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal">
                                <Button Content="更新" Command="{Binding RefreshHistoryCommand}"
                                       ToolTip="リリース履歴を最新の状態に更新します"/>
                            </StackPanel>

                            <ListView Grid.Row="1" ItemsSource="{Binding ReleaseHistory}" Margin="0,5,0,0"
                                     VirtualizingStackPanel.IsVirtualizing="True"
                                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                                     ScrollViewer.IsDeferredScrollingEnabled="True">
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header="リリース名" Width="200" DisplayMemberBinding="{Binding ReleaseName}"/>
                                        <GridViewColumn Header="リリース日時" Width="150" DisplayMemberBinding="{Binding ReleaseDate, StringFormat=yyyy/MM/dd HH:mm:ss}"/>
                                        <GridViewColumn Header="ソースパス" Width="250" DisplayMemberBinding="{Binding SourcePath}"/>
                                        <GridViewColumn Header="ターゲットパス" Width="250" DisplayMemberBinding="{Binding TargetPath}"/>
                                        <GridViewColumn Header="ファイル数" Width="80" DisplayMemberBinding="{Binding FilesReleased}"/>
                                        <GridViewColumn Header="ステータス" Width="80">
                                            <GridViewColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Status}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding Status}" Value="Success">
                                                                        <Setter Property="Foreground" Value="Green"/>
                                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Status}" Value="Error">
                                                                        <Setter Property="Foreground" Value="Red"/>
                                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </DataTemplate>
                                            </GridViewColumn.CellTemplate>
                                        </GridViewColumn>
                                        <GridViewColumn Header="操作" Width="150">
                                            <GridViewColumn.CellTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal">
                                                        <Button Content="復元" Command="{Binding DataContext.RestoreFromBackupCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                               CommandParameter="{Binding}" 
                                                               Margin="2" Padding="5,2" FontSize="10"
                                                               ToolTip="このリリースのバックアップから復元します"/>
                                                        <Button Content="削除" Command="{Binding DataContext.DeleteReleaseCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                               CommandParameter="{Binding}" 
                                                               Margin="2" Padding="5,2" FontSize="10"
                                                               ToolTip="このリリース履歴を削除します"/>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </GridViewColumn.CellTemplate>
                                        </GridViewColumn>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                        </Grid>
                    </GroupBox>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- ステータスバー -->
        <StatusBar Grid.Row="2">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</UserControl>